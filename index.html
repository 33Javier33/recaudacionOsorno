<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Recaudación</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --menu-width: 250px; --primary-color: #007bff; --secondary-color: #28a745; --bg-main: #f4f4f4;
            --bg-content: #ffffff; --text-primary: #333; --text-secondary: #555; --border-color: #ddd;
            --shadow-color: rgba(0, 0, 0, 0.1); --header-bg: #f2f2f2; --row-color-even: #ffffff;
            --row-color-odd: #e7f5ff; --row-footer-odd: #dbeffc; --unread-bg: #fff3cd;
        }
        body.dark-mode {
            --bg-main: #121212; --bg-content: #1e1e1e; --text-primary: #e0e0e0; --text-secondary: #b0b0b0;
            --border-color: #444; --shadow-color: rgba(0, 0, 0, 0.4); --header-bg: #2a2a2a;
            --row-color-even: #1e1e1e; --row-color-odd: #2c3e50; --row-footer-odd: #34495e; --unread-bg: #53450e;
        }
        body { font-family: Arial, sans-serif; background-color: var(--bg-main); color: var(--text-primary); margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        body.loggedin { display: block; justify-content: initial; align-items: initial; }
        .menu-toggle { position: fixed; top: 15px; left: 15px; z-index: 1002; width: 40px; height: 40px; background-color: var(--primary-color); border: none; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: left 0.3s ease; }
        .menu-toggle span { display: block; width: 22px; height: 2px; background-color: white; margin: 2px 0; transition: all 0.3s ease; }
        .side-menu.open + .main-container .menu-toggle { left: calc(var(--menu-width) + 15px); }
        .menu-toggle.active span:nth-child(1) { transform: translateY(6px) rotate(45deg); }
        .menu-toggle.active span:nth-child(2) { opacity: 0; }
        .menu-toggle.active span:nth-child(3) { transform: translateY(-6px) rotate(-45deg); }
        .side-menu { position: fixed; top: 0; left: 0; width: var(--menu-width); height: 100vh; background-color: #2c3e50; z-index: 1001; transform: translateX(-100%); transition: transform 0.3s ease; display: flex; flex-direction: column; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        .side-menu.open { transform: translateX(0); }
        .menu-header { color: white; font-size: 1.4em; font-weight: 700; text-align: center; padding: 20px 10px; border-bottom: 1px solid #4a627a; flex-shrink: 0; }
        .menu-links-container { flex-grow: 1; overflow-y: auto; }
        .side-menu a { color: white; text-decoration: none; padding: 15px 20px; display: block; font-size: 1.0em; transition: background-color 0.2s ease, padding-left 0.2s ease; border-bottom: 1px solid #3e5268; }
        .side-menu a:hover, .side-menu a.active-link { background-color: var(--primary-color); padding-left: 25px; }
        #logoutBtn { background-color: #c82333; border-bottom: none; border-top: 1px solid #4a627a; }
        .unread-indicator { background-color: #dc3545; width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-left: 8px; vertical-align: middle; transition: opacity 0.3s ease; opacity: 0; }
        .unread-indicator.show { opacity: 1; }
        .main-container { transition: margin-left 0.3s ease; width: 100%; }
        .content-panel { display: none; }
        .content-panel.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (min-width: 992px) { body.loggedin { margin-left: var(--menu-width); } .menu-toggle { display: none; } .side-menu { transform: translateX(0); } }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; transition: opacity 0.3s ease, visibility 0.3s ease; }
        #loginOverlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        #loginBox { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.3); width: 90%; max-width: 350px; text-align: center; }
        #loginBox h2 { margin-bottom: 25px; color: #333; }
        #loginBox label { display: block; margin-bottom: 10px; text-align: left; font-weight: bold; color: #555; }
        #loginBox input[type="text"], #loginBox input[type="password"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        #loginBox button { width: 100%; padding: 12px; background-color: #007bff; border: none; border-radius: 4px; color: white; font-size: 18px; cursor: pointer; transition: background-color 0.3s ease; margin-top: 10px;}
        .password-wrapper { position: relative; display: flex; align-items: center; }
        .password-wrapper input { width: 100%; padding-right: 40px; }
        .password-wrapper i { position: absolute; right: 10px; cursor: pointer; color: #888; }
        #mainContent { display: none; padding: 0 15px; }
        h2, h3 { text-align: center; color: var(--text-primary); }
        h2 { margin-top: 20px; }
        .form-container, .table-container { background-color: var(--bg-content); padding: 20px; margin: 20px auto; border-radius: 8px; box-shadow: 0 0 10px var(--shadow-color); max-width: 800px; }
        #globalLoaderOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 3000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; pointer-events: none; }
        #globalLoaderOverlay.show { opacity: 1; visibility: visible; pointer-events: auto; }
        .loader-content { text-align: center; color: white; }
        .loader { border: 5px solid rgba(255, 255, 255, 0.3); border-top: 5px solid #ffffff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto; }
        .loader-content p { margin-top: 15px; font-weight: bold; font-size: 1.1em; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .balance-info-container { background-color: var(--bg-main); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px var(--shadow-color); margin: 0 auto 15px auto; max-width: 400px; }
        .controls-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px auto; max-width: 900px; padding: 0 20px; }
        .main-buttons-group { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; width: 100%; margin-bottom: 10px; }
        .control-group, #btnReiniciarFiltros, .data-management-group { display: none; }
        .controls-expanded .control-group, .controls-expanded #btnReiniciarFiltros, .controls-expanded .data-management-group { display: block; }
        .data-management-group { display:flex; flex-wrap:wrap; gap: 8px; justify-content: center; width:100%; margin-top:10px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-secondary); }
        input[type="date"], input[type="tel"], input[type="text"], input[type="number"], select, textarea, input[type="file"] { width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; background-color: var(--bg-content); color: var(--text-primary); }
        button, .download-link { padding: 8px 12px; background-color: var(--secondary-color); border: none; border-radius: 4px; color: white !important; font-size: 14px; cursor: pointer; transition: background-color 0.3s ease; white-space: nowrap; text-decoration: none; display: inline-block; text-align: center;}
        button:hover, .download-link:hover { background-color: #218838; }
        .button-delete, .delete-btn { background-color: #dc3545; }
        .button-delete:hover, .delete-btn:hover { background-color: #c82333; }
        .button-reset, .download-link { background-color: #007bff; }
        .button-reset:hover, .download-link:hover { background-color: #0056b3; }
        .button-copy, .copy-btn { background-color: #ffc107; color: #333 !important; }
        .button-copy:hover, .copy-btn:hover { background-color: #e0a800; }
        .button-danger { background-color: #c82333; }
        .fab-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .fab { background-color: #030406c5; color: white; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 2px 10px var(--shadow-color); cursor: pointer; transition: all 0.3s ease; }
        .fab:hover { background-color: var(--primary-color); transform: scale(1.05); }
        #scrollToTopBtn { opacity: 0; visibility: hidden; }
        #scrollToTopBtn.show { opacity: 1; visibility: visible; }
        #notesFabBtn { display: none; background-color: #ffc107; }
        .pulsing { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); } }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; border: 1px solid var(--border-color); text-align: left; }
        th { background-color: var(--header-bg); font-weight: bold; }
        tfoot td { font-weight: bold; text-align: left; }
        tfoot tr { background-color: var(--header-bg); }
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 60px; }
        .modal-content { background-color: var(--bg-content); margin: 5% auto; padding: 20px; border: 1px solid var(--border-color); width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 0 10px var(--shadow-color); text-align: center; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .fecha-par tbody tr { background-color: var(--row-color-even); }
        .fecha-impar tbody tr { background-color: var(--row-color-odd); }
        .fecha-impar tfoot tr { background-color: var(--row-footer-odd); }
        .fecha-impar tfoot td, .fecha-par tfoot td { background-color: transparent; }
        #notes-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .note-card { background-color: var(--bg-content); border: 1px solid var(--border-color); border-left: 5px solid var(--primary-color); border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px var(--shadow-color); position: relative; transition: background-color 0.3s; }
        .note-unread { background-color: var(--unread-bg); border-left-color: #ffc107; }
        .note-header { font-size: 0.8em; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 12px; }
        .note-header .author { font-weight: bold; color: var(--primary-color); text-transform: capitalize; }
        .note-body { font-size: 0.95em; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
        .note-delete-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; cursor: pointer; font-size: 16px; padding: 5px; }
        .note-delete-btn i { color: var(--text-secondary); transition: color 0.2s ease; }
        .note-delete-btn:hover i { color: #dc3545; }
        #ayudaPanel { position: fixed; top: 0; right: 0; width: 380px; max-width: 90%; height: 100%; background-color: var(--bg-content); z-index: 1050; transform: translateX(100%); transition: transform 0.3s ease-in-out; overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.2); display: block !important; animation: none; }
        #ayudaPanel.open { transform: translateX(0); }
        .close-ayuda { position: absolute; top: 15px; right: 25px; font-size: 30px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; }
        footer { text-align: center; padding: 20px; margin-top: 30px; border-top: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.9em; }
        @media (max-width: 600px) { 
            h2 { margin-top: 20px; } 
            .controls-container { flex-direction: column; align-items: center; } 
            .main-buttons-group { flex-direction: row; justify-content: center; width: 100%; } 
            .main-buttons-group button { flex-grow: 1; min-width: unset; font-size: 13px; padding: 7px 10px; } 
            table, thead, tbody, th, td, tr { display: block; } 
            thead tr { position: absolute; top: -9999px; left: -9999px; } 
            tr { border: 1px solid var(--border-color); margin-bottom: 10px; display: flex; flex-wrap: wrap; } 
            td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 50%; text-align: right; width: 100%; background-color: transparent !important; } 
            td:before { content: attr(data-label); position: absolute; left: 6px; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; } 
            tfoot tr { display: flex; flex-wrap: wrap; width: 100%; border: 1px solid #ccc; margin-top: 10px; } 
            tfoot td { width: 100%; text-align: right; padding-left: 50%; } 
            tfoot td:first-child { text-align: left; } 
            .fecha-par tr, .fecha-impar tr { background-color: transparent; }
        }
    </style>
</head>
<body>
    <div id="globalLoaderOverlay"><div class="loader-content"><div class="loader"></div><p id="globalLoaderMessage">Procesando...</p></div></div>
    <div id="loginOverlay">
        <div id="loginBox">
            <h2>Acceso Requerido</h2>
            <form id="loginForm">
                <label for="username">Usuario:</label>
                <input type="text" id="username" required autocomplete="username">
                <label for="password">Contraseña:</label>
                <div class="password-wrapper">
                    <input type="password" id="password" required autocomplete="current-password">
                    <i class="fas fa-eye" id="togglePassword"></i>
                </div>
                <button type="submit">Entrar</button>
                <p id="loginMessage" style="display: none;"></p>
            </form>
            <p style="font-size: 12px; color: #666; margin-top: 15px;">El usuario y la contraseña deben ser solicitados al administrador.</p>
        </div>
    </div>

    <nav id="sideMenu" class="side-menu"></nav>
    <div id="mainContainer" class="main-container">
        <button id="menuToggle" class="menu-toggle" style="display: none;"><span></span><span></span><span></span></button>
        <div id="mainContent">
            <section id="historialPanel" class="content-panel">
                <h2>Datos Recaudados</h2>
                <div class="balance-info-container">
                    <h3>Total Recaudado: <span id="totalRecaudadoHistorial"></span></h3>
                    <h3>Total General División: <span id="totalGeneralDivisionHistorial"></span></h3>
                </div>
                <div class="controls-container" id="controlsContainer">
                    <div class="main-buttons-group">
                        <button id="btnMinimizarTabla">Maximizar Tabla</button> 
                        <button id="btnOrdenarFechaAsc" class="button-reset">Fecha (Antiguo)</button>
                        <button id="btnOrdenarFechaDesc" class="button-reset">Fecha (Reciente)</button>
                    </div>
                    <div class="control-group">
                        <label for="filtroFechas">Filtrar por fechas (AAAA-MM-DD, AAAA-MM-DD):</label>
                        <input type="text" id="filtroFechas" placeholder="Ej: 2023-01-01, 2023-01-05">
                    </div>
                    <button id="btnReiniciarFiltros" class="button-reset">Reiniciar Filtros</button>
                    <div class="data-management-group">
                        <button id="btnReiniciarMes" class="button-danger">Reiniciar Mes</button>
                        <button id="btnExportarJson" class="button-reset">Exportar JSON</button>
                        <button id="btnImportarJsonTrigger" class="button-warning">Importar JSON</button>
                        <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
                    </div>
                </div>
                <div class="table-container" id="tableContainerScrollTarget"><div id="tablaContainer"></div></div>
            </section>

            <section id="agregarPanel" class="content-panel">
                <div class="form-container" style="max-width: 400px;">
                    <div class="balance-info-container">
                        <h3>Total Recaudado: <span id="totalRecaudadoAgregar"></span></h3>
                        <h3>Total General División: <span id="totalGeneralDivisionAgregar"></span></h3>
                    </div><hr style="margin-bottom: 25px;">
                    <h2>Agregar Datos</h2>
                    <form id="agregarForm">
                        <label for="tipo">Tipo:</label>
                        <select id="tipo" name="tipo"><option value="Máquinas">Máquinas</option><option value="Mesas">Mesas</option><option value="Otras">Otras</option></select>
                        <label for="fecha">Fecha:</label>
                        <input type="date" id="fecha" name="fecha" required>
                        <label for="monto">Monto Recaudado:</label>
                        <input type="tel" id="monto" name="monto" oninput="formatearMonto(this)" required>
                        <button type="submit">Agregar</button>
                    </form>
                </div>
            </section>
            
            <section id="importarPanel" class="content-panel">
                 <div class="form-container" style="max-width: 400px;">
                    <h2>Importar Datos desde Texto</h2>
                    <p>Pega aquí el texto de los datos de recaudación (ej. desde WhatsApp):</p>
                    <textarea id="importDataTextarea" rows="10" placeholder="Pega el texto aquí..."></textarea>
                    <button id="btnProcesarImportacion">Procesar Importación</button>
                </div>
            </section>

            <section id="notasPanel" class="content-panel">
                <h2>Bloc de Notas</h2>
                <div class="form-container">
                    <label for="notaMensaje">Escribe una nueva nota:</label>
                    <textarea id="notaMensaje" rows="4" placeholder="Deja un recordatorio o mensaje..."></textarea>
                    <button id="btnAgregarNota">Guardar Nota</button>
                </div>
                <div id="notes-container"></div>
            </section>

            <section id="ayudaPanel" class="content-panel">
                <div class="form-container">
                    <span class="close-ayuda">&times;</span>
                    <h2>Guía de Uso</h2>
                    <p style="text-align: center;">Sigue estos pasos para llevar un registro ordenado.</p>
                    <hr style="margin: 20px 0;">
                    <h3><i class="fas fa-plus-circle"></i>Paso 1: Agrega tus Recaudaciones</h3>
                    <p>El primer paso es registrar todo el dinero que entra.</p>
                    <ol>
                        <li>Ve a la pestaña <strong>"Agregar Dato"</strong>.</li>
                        <li>Completa el formulario con el tipo, la fecha y el monto.</li>
                        <li>Haz clic en "Agregar".</li>
                    </ol>
                    <h3><i class="fas fa-history"></i>Paso 2: Revisa y Gestiona tu Historial</h3>
                    <p>En la pestaña <strong>"Historial"</strong> podrás ver y administrar tus registros. Solo el Administrador puede editar y borrar cualquier registro.</p>
                    <ul>
                        <li><strong>Editar:</strong> Se utiliza para corregir montos o tipos.</li>
                        <li><strong>Borrar:</strong> Elimina permanentemente el registro.</li>
                    </ul>
                    <h3><i class="fas fa-sticky-note"></i>Paso 3: Bloc de Notas</h3>
                    <p>La sección de <strong>"Notas"</strong> sirve como un tablero de comunicación. Si hay una nota nueva que no has leído, verás un <strong>punto rojo</strong> en el menú y un <strong>icono parpadeante</strong> en la esquina.</p>
                    <ul>
                        <li>Para que las notificaciones desaparezcan, solo tienes que hacer clic en la pestaña "Notas".</li>
                        <li>El Administrador puede borrar cualquier nota.</li>
                    </ul>
                    <h3><i class="fas fa-divide"></i>Paso 4: Divisor Diario y Total General</h3>
                    <p>Esta es una herramienta para hacer cálculos rápidos sobre el total de un día.</p>
                    <ul>
                        <li>En la tabla del <strong>Historial</strong>, cada día tiene una casilla: <strong>"Dividir total por:"</strong>.</li>
                        <li>Ingresa un número en esa casilla (por ejemplo, la cantidad de personas) y el resultado de la división aparecerá al instante.</li>
                        <li>El <strong>"Total General División"</strong> que ves arriba de la tabla es la suma de todos los resultados de estas divisiones diarias.</li>
                    </ul>
                    <h3><i class="fas fa-cogs"></i>Paso 5: Funciones Avanzadas</h3>
                    <p>En la vista expandida del Historial, encontrarás botones para gestionar tus datos.</p>
                    <ul>
                        <li><strong>Exportar JSON:</strong> Crea una copia de seguridad de todos tus datos (recaudaciones, notas, divisores) en un archivo. Es muy recomendable hacerlo periódicamente.</li>
                        <li><strong>Importar JSON:</strong> <strong style="color: #dc3545;">¡CUIDADO!</strong> Esta acción borra todos los datos actuales y los reemplaza con los del archivo que selecciones. Úsalo solo para restaurar una copia de seguridad.</li>
                        <li><strong>Importar Texto:</strong> Permite pegar datos copiados desde otra aplicación (como WhatsApp), siempre que sigan el formato correcto.</li>
                    </ul>
                </div>
            </section>
            
            <div class="fab-container">
                <button id="notesFabBtn" class="fab" title="Nuevas Notas"><i class="fas fa-sticky-note"></i></button>
                <button id="ayudaFabBtn" class="fab" title="Ayuda"><i class="fas fa-question-circle"></i></button>
                <button id="themeToggle" class="fab theme-toggle" title="Cambiar Tema"><i class="fas fa-moon"></i></button>
                <button id="scrollToTopBtn" class="fab scroll-to-top" title="Ir al inicio"><i class="fas fa-arrow-up"></i></button>
            </div>
            
            <footer><p>CarlosPN Interactive®</p></footer>
        </div>
    </div> 

    <div id="editModal" class="modal"><div class="modal-content"><span class="close">&times;</span><h2>Editar Datos</h2><form id="editarForm"><label for="editarTipo">Tipo:</label><select id="editarTipo" name="editarTipo"><option value="Máquinas">Máquinas</option><option value="Mesas">Mesas</option><option value="Otras">Otras</option></select><label for="editarFecha">Fecha:</label><input type="date" id="editarFecha" name="editarFecha" required><label for="editarMonto">Monto Recaudado:</label><input type="tel" id="editarMonto" name="editarMonto" oninput="formatearMonto(this)" required><button type="submit">Guardar</button></form></div></div>
    <div id="alertModal" class="modal"><div class="modal-content" style="max-width: 400px;"><span class="close">&times;</span><p id="alertMessage" style="text-align: center; margin-top: 20px; font-size: 1.1em;"></p><button id="alertOkBtn" class="button-reset" style="display: block; margin: 20px auto 0 auto; min-width: 100px;">OK</button></div></div>
    <div id="confirmModal" class="modal"><div class="modal-content" style="max-width: 400px;"><p id="confirmMessage" style="text-align: center; margin: 20px 0; font-size: 1.1em; white-space: pre-wrap;"></p><div style="display: flex; justify-content: center; gap: 20px;"><button id="confirmOkBtn" style="min-width: 100px;">Confirmar</button><button id="confirmCancelBtn" class="button-delete" style="min-width: 100px;">Cancelar</button></div></div></div>
    
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Descargar Respaldo</h2>
            <p>El respaldo está listo. Haz clic en el botón para guardarlo.</p>
            <div id="exportLinkContainer" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const VALID_USERNAME = 'Osorno';
        const VALID_PASSWORD = '1234';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyKOYiSV7b2Kb0GBNCvRbACSP3qmX71FIepWO1hJxZQ2kqNClxWi2-o1J4u6gzRdlWCaQ/exec';

        // Ahora solo existirá el rol 'admin' (o será null/undefined)
        let currentUserRole = null; 
        let lastSeenKey = '';
        let datos = [];
        let notes = [];
        let divisores = {}; 
        let saldoInicialGuardado = { fecha: null, monto: null };
        let minimizado = true;
        let ordenFecha = 'desc';
        let editIndex = -1;
        let debounceTimer;
        let notesUpdateInterval = null;
        let dataUpdateInterval = null;
        let allowAutoLogout = true;
        let currentExportUrl = null;
        
        let inactivityTimer;
        const INACTIVITY_TIMEOUT = 5 * 60 * 1000;

        function logout() {
            if (notesUpdateInterval) clearInterval(notesUpdateInterval);
            if (dataUpdateInterval) clearInterval(dataUpdateInterval);
            sessionStorage.clear();
            location.reload();
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(logout, INACTIVITY_TIMEOUT);
        }

        const mainContent = document.getElementById('mainContent');
        const loginOverlay = document.getElementById('loginOverlay');
        const globalLoader = document.getElementById('globalLoaderOverlay');
        const globalLoaderMessage = document.getElementById('globalLoaderMessage');
        const sideMenu = document.getElementById('sideMenu');
        const menuToggle = document.getElementById('menuToggle');

        const showGlobalLoader = (message = 'Procesando...') => { globalLoaderMessage.textContent = message; globalLoader.classList.add('show'); };
        const hideGlobalLoader = () => globalLoader.classList.remove('show');
        const showModal = (id) => document.getElementById(id).style.display = 'block';
        const hideModal = (id) => {
            document.getElementById(id).style.display = 'none';
            if (id === 'exportModal' && currentExportUrl) {
                URL.revokeObjectURL(currentExportUrl);
                currentExportUrl = null;
                document.getElementById('exportLinkContainer').innerHTML = '';
            }
        };
        
        const showAlert = (message) => { document.getElementById('alertMessage').textContent = message; showModal('alertModal'); };
        const showConfirm = (message, onConfirm) => {
            const okBtn = document.getElementById('confirmOkBtn');
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            document.getElementById('confirmMessage').textContent = message;
            newOkBtn.onclick = () => { hideModal('confirmModal'); onConfirm(); };
            document.getElementById('confirmCancelBtn').onclick = () => hideModal('confirmModal');
            showModal('confirmModal');
        };
        const formatearFecha = (fechaStr, includeTime = false) => {
            if (!fechaStr) return 'N/A';
            const date = includeTime ? new Date(fechaStr) : new Date(fechaStr + 'T12:00:00');
            const options = { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'America/Santiago' };
            if (includeTime) { options.hour = '2-digit'; options.minute = '2-digit'; }
            return date.toLocaleString('es-ES', options);
        };
        const formatearNumero = (num) => isNaN(num) || num === null ? '$0' : `$${Math.ceil(num).toLocaleString('es-ES')}`;
        window.formatearMonto = (input) => {
            let valor = input.value.replace(/\D/g, '');
            input.value = valor ? parseInt(valor, 10).toLocaleString('es-ES') : '';
        };

        async function fetchFromScript(params, retries = 2, delay = 1500) {
            const url = new URL(SCRIPT_URL);
            url.searchParams.append('v', new Date().getTime());
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Error de red: ${response.statusText}`);
                const result = await response.json();
                if (result.status === 'error') throw new Error(result.message);
                return result;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchFromScript(params, retries - 1, delay);
                } else {
                    showAlert(`Error de Conexión persistente: ${error.message}.`);
                    return { status: 'error', message: error.message };
                }
            }
        }

        async function postToScript(data, retries = 2, delay = 1500) {
            const url = new URL(SCRIPT_URL);
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data),
                });
                if (!response.ok) throw new Error(`Error de red: ${response.statusText}`);
                const result = await response.json();
                if (result.status === 'error') throw new Error(result.message);
                return result;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return postToScript(data, retries - 1, delay);
                } else {
                    showAlert(`Error persistente al enviar datos: ${error.message}.`);
                    return { status: 'error', message: error.message };
                }
            }
        }
        
        const setupMenu = () => {
            sideMenu.innerHTML = `<div class="menu-header">Menú</div><div class="menu-links-container"></div>`;
            const container = sideMenu.querySelector('.menu-links-container');
            const menuItems = [
                { id: 'agregarPanel', title: 'Agregar Dato', icon: 'fa-plus-circle' },
                { id: 'historialPanel', title: 'Historial', icon: 'fa-history' },
                { id: 'importarPanel', title: 'Importar Texto', icon: 'fa-file-import' },
                { id: 'notasPanel', title: 'Notas', icon: 'fa-sticky-note' }
            ];
            let menuHtml = '';
            menuItems.forEach(item => {
                menuHtml += `<a href="#" class="menu-link" data-target="${item.id}"><i class="fas ${item.icon}"></i> ${item.title} ${item.id === 'notasPanel' ? '<span class="unread-indicator" id="notes-indicator"></span>' : ''}</a>`;
            });
            container.innerHTML = menuHtml;
            sideMenu.innerHTML += `<a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>`;
        };
        
        const actualizarUI = () => {
            const totalRecaudado = datos.reduce((sum, d) => sum + d.monto, 0);
            document.querySelectorAll('#totalRecaudadoHistorial, #totalRecaudadoAgregar').forEach(el => el.textContent = formatearNumero(totalRecaudado));
            actualizarTotalGeneralDivision();
        };

        const actualizarTotalGeneralDivision = () => {
            const totalesPorDia = datos.reduce((acc, dato) => {
                acc[dato.fecha] = (acc[dato.fecha] || 0) + dato.monto;
                return acc;
            }, {});

            const totalGeneral = Object.keys(totalesPorDia).reduce((sum, fecha) => {
                const divisor = divisores[fecha];
                return divisor > 0 ? sum + (totalesPorDia[fecha] / divisor) : sum;
            }, 0);
            document.getElementById('totalGeneralDivisionHistorial').textContent = formatearNumero(totalGeneral);
            document.getElementById('totalGeneralDivisionAgregar').textContent = formatearNumero(totalGeneral);
        };
        
        const renderizarTabla = () => {
            const filtro = document.getElementById('filtroFechas').value.trim();
            const datosFiltrados = filtro ? datos.filter(d => filtro.split(',').map(f => f.trim()).includes(d.fecha)) : datos;

            const tablaContainer = document.getElementById('tablaContainer');
            tablaContainer.innerHTML = '';
            const datosPorFecha = datosFiltrados.reduce((acc, dato) => {
                (acc[dato.fecha] = acc[dato.fecha] || []).push(dato);
                return acc;
            }, {});

            const fechasOrdenadas = Object.keys(datosPorFecha).sort((a,b) => ordenFecha === 'asc' ? new Date(a) - new Date(b) : new Date(b) - new Date(a));
            if (fechasOrdenadas.length === 0) {
                tablaContainer.innerHTML = '<p style="text-align:center; padding:20px;">No hay datos para mostrar.</p>';
                return;
            }

            fechasOrdenadas.forEach((fecha, i) => {
                if (minimizado && fechasOrdenadas.length > 1 && fecha !== fechasOrdenadas[0]) return;
                
                const totalDia = datosPorFecha[fecha].reduce((sum, d) => sum + d.monto, 0);
                const divisor = divisores[fecha] || '';
                const resultadoDivision = divisor ? totalDia / divisor : 0;
                
                let tbodyHtml = '';
                // Simplificación: Solo el admin puede editar/borrar
                const isAdmin = currentUserRole === 'admin'; 

                datosPorFecha[fecha].forEach(dato => {
                    let accionesHtml = '';
                    if (isAdmin) {
                        accionesHtml += `<button class="edit-btn" data-index="${dato.originalIndex}"><i class="fas fa-pencil-alt"></i></button>`;
                        accionesHtml += `<button class="delete-btn" data-index="${dato.originalIndex}"><i class="fas fa-trash-alt"></i></button>`;
                    }
                    tbodyHtml += `<tr><td data-label="Fecha">${formatearFecha(dato.fecha)}</td><td data-label="Tipo">${dato.tipo}</td><td data-label="Monto">${formatearNumero(dato.monto)}</td><td data-label="Acciones">${accionesHtml}</td></tr>`;
                });

                const tablaHtml = `
                    <table class="${i % 2 === 0 ? 'fecha-par' : 'fecha-impar'}">
                        <thead><tr><th>Fecha</th><th>Tipo</th><th>Monto</th><th>Acciones</th></tr></thead>
                        <tbody>${tbodyHtml}</tbody>
                        <tfoot>
                            <tr><td colspan="2"><strong>Total Día:</strong></td><td>${formatearNumero(totalDia)}</td><td><button class="copy-btn" data-fecha="${fecha}">Copiar</button></td></tr>
                            <tr>
                                <td data-label="Divisor:" colspan="2">
                                    <strong>Dividir total por:</strong>
                                    <input type="number" min="1" class="divisor-input" value="${divisor}" data-fecha="${fecha}" style="width:60px;padding:5px;margin-left:8px;text-align:center;">
                                </td>
                                <td data-label="Resultado División:"><strong id="resultado-division-${fecha}">${formatearNumero(resultadoDivision)}</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>`;
                tablaContainer.innerHTML += tablaHtml;
            });
        };

        const renderizarNotas = () => {
            const container = document.getElementById('notes-container');
            const lastSeen = localStorage.getItem(lastSeenKey) || 0;

            if (!notes || notes.length === 0) {
                container.innerHTML = '<p>Aún no hay notas.</p>';
                return;
            }
            
            const notasOrdenadas = notes.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            const isAdmin = currentUserRole === 'admin';

            const notesHtml = notasOrdenadas.map(nota => {
                let deleteBtn = '';
                // Simplificación: Solo el admin puede borrar notas
                if (isAdmin) {
                    deleteBtn = `<button class="note-delete-btn" data-index="${nota.originalIndex}" title="Eliminar nota"><i class="fas fa-trash-alt"></i></button>`;
                }

                // Check unread status (still comparing against current user role, which is now always 'admin')
                const isUnread = nota.autor !== currentUserRole && new Date(nota.fecha).getTime() > lastSeen;
                
                return `
                    <div class="note-card ${isUnread ? 'note-unread' : ''}">
                        ${deleteBtn}
                        <div class="note-header">Por <span class="author">${nota.autor || 'Desconocido'}</span> el ${formatearFecha(nota.fecha, true)}</div>
                        <div class="note-body">${nota.mensaje}</div>
                    </div>`;
            }).join('');

            container.innerHTML = notesHtml;
        };
        
        async function cargarDatosIniciales(showLoader = true) {
            if(showLoader) showGlobalLoader('Cargando datos...');
            try {
                const [loadedDatos, loadedSaldo, loadedNotas, loadedDivisores] = await Promise.all([
                    fetchFromScript({ action: 'get' }), 
                    fetchFromScript({ action: 'getSaldo' }), 
                    fetchFromScript({ action: 'getNotes' }), 
                    fetchFromScript({ action: 'getDivisores' })
                ]);
                
                if (loadedDatos.status === 'success') datos = loadedDatos.data || [];
                if (loadedNotas.status === 'success') notes = loadedNotas.data || [];
                if (loadedSaldo.status === 'success') saldoInicialGuardado = loadedSaldo.data || { fecha: null, monto: null };
                if (loadedDivisores.status === 'success') divisores = loadedDivisores.data || {};
                
                actualizarUI();
                renderizarTabla();
                renderizarNotas();
                checkUnreadNotes();
            } catch(error) {
                console.error("Falla en la carga inicial de datos:", error);
            } finally {
                if(showLoader) hideGlobalLoader();
            }
        }

        const checkUnreadNotes = () => {
            const lastSeen = localStorage.getItem(lastSeenKey) || 0;
            // Solo considera notas no leídas si el autor NO es el admin actual
            const hasUnread = notes.some(n => n.autor !== currentUserRole && new Date(n.fecha).getTime() > lastSeen);
            const notesIndicator = document.getElementById('notes-indicator');
            if (notesIndicator) notesIndicator.classList.toggle('show', hasUnread);
            document.getElementById('notesFabBtn').style.display = hasUnread ? 'flex' : 'none';
        };

        const markNotesAsRead = () => {
            // Marca como leído hasta la nota más reciente de cualquier otro usuario (si la hay)
            const lastNoteFromOther = notes.filter(n => n.autor !== currentUserRole).sort((a,b) => new Date(b.fecha) - new Date(a.fecha))[0];
            if (lastNoteFromOther) {
                localStorage.setItem(lastSeenKey, new Date(lastNoteFromOther.fecha).getTime());
            }
            renderizarNotas();
            checkUnreadNotes();
        };

        const setupAppEventListeners = () => {
            menuToggle.onclick = (e) => { e.stopPropagation(); sideMenu.classList.toggle('open'); };
            document.querySelector('.main-container').onclick = () => {
                if (sideMenu.classList.contains('open')) {
                    sideMenu.classList.remove('open');
                }
            };
            document.querySelectorAll('.modal .close, #alertOkBtn').forEach(el => el.onclick = (e) => hideModal(e.target.closest('.modal').id));
            window.onclick = (e) => { if (e.target.classList.contains('modal')) hideModal(e.target.id); };
            
            const ayudaPanel = document.getElementById('ayudaPanel');
            document.getElementById('ayudaFabBtn').onclick = () => ayudaPanel.classList.add('open');
            const closeAyudaBtn = document.querySelector('#ayudaPanel .close-ayuda');
            if(closeAyudaBtn) closeAyudaBtn.onclick = () => ayudaPanel.classList.remove('open');

            window.addEventListener('focus', () => {
                if (!allowAutoLogout) {
                    allowAutoLogout = true;
                }
            });

            document.addEventListener('click', async (e) => {
                const target = e.target.closest('button, a');
                if (!target) return;

                const isDownload = target.classList.contains('download-link');
                
                if (target.closest('form') === null && !isDownload) {
                     e.preventDefault();
                }

                if (target.closest('.note-delete-btn')) {
                    const index = parseInt(target.closest('.note-delete-btn').dataset.index);
                    showConfirm('¿Borrar esta nota permanentemente?', async () => {
                        showGlobalLoader('Borrando nota...');
                        const response = await postToScript({ action: 'deleteNote', index: index });
                        if (response.status === 'success') {
                           await cargarDatosIniciales(false);
                        }
                        hideGlobalLoader();
                    });
                    return;
                }
                
                if (target.id === 'logoutBtn') { logout(); }
                if (target.matches('.menu-link')) {
                    document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
                    document.getElementById(target.dataset.target).classList.add('active');
                    document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active-link'));
                    target.classList.add('active-link');
                    sessionStorage.setItem('activeTab', target.dataset.target);
                    if (target.dataset.target === 'notasPanel') markNotesAsRead();
                    if (window.innerWidth < 992) sideMenu.classList.remove('open');
                }
                if (target.matches('.edit-btn')) {
                    const index = parseInt(target.dataset.index);
                    const dato = datos.find(d => d.originalIndex === index);
                    if (dato) {
                        editIndex = index;
                        document.getElementById('editarTipo').value = dato.tipo;
                        document.getElementById('editarFecha').value = dato.fecha;
                        document.getElementById('editarMonto').value = String(dato.monto);
                        window.formatearMonto(document.getElementById('editarMonto'));
                        showModal('editModal');
                    }
                }
                if (target.matches('.delete-btn')) {
                    const index = parseInt(target.dataset.index);
                    showConfirm('¿Borrar este dato permanentemente?', async () => {
                        showGlobalLoader('Borrando...');
                        const response = await postToScript({ action: 'delete', index: index });
                        if (response.status === 'success') await cargarDatosIniciales(false);
                        hideGlobalLoader();
                    });
                }
                 if (target.matches('.copy-btn')) {
                    const fecha = target.dataset.fecha;
                    const datosDelDia = datos.filter(d => d.fecha === fecha);
                    let texto = `Datos de Recaudación del Día ${formatearFecha(fecha)}:\n`;
                    let total = 0;
                    const porTipo = {};
                    datosDelDia.forEach(d => { porTipo[d.tipo] = (porTipo[d.tipo] || 0) + d.monto; total += d.monto; });
                    for (const tipo in porTipo) { texto += `- ${tipo}: ${formatearNumero(porTipo[tipo])}\n`; }
                    texto += `Total del Día: ${formatearNumero(total)}\n`;
                    navigator.clipboard.writeText(texto).then(() => showAlert('Datos copiados!')).catch(() => showAlert('Error al copiar.'));
                }
                 if (target.id === 'btnAgregarNota') {
                    const mensaje = document.getElementById('notaMensaje').value.trim();
                    if (mensaje) {
                        showGlobalLoader('Guardando nota...');
                        // El autor de la nota es el rol actual, que ahora solo puede ser 'admin'
                        const response = await postToScript({ action: 'addNote', autor: currentUserRole, mensaje });
                        if (response.status === 'success') {
                            document.getElementById('notaMensaje').value = '';
                            await cargarDatosIniciales(false);
                        }
                        hideGlobalLoader();
                    } else { showAlert('Escribe un mensaje.'); }
                }
                if (target.id === 'btnReiniciarMes') {
                    showConfirm('¿Borrar TODOS los datos de recaudación y divisores?\nLas notas se conservarán.', async () => {
                        showGlobalLoader('Reiniciando mes...');
                        if ((await postToScript({ action: 'clearAll' })).status === 'success') await cargarDatosIniciales(false);
                        hideGlobalLoader();
                    });
                }
                if (target.id === 'btnExportarJson') {
                     try {
                        const dataToExport = {
                            recaudaciones: datos,
                            notas: notes,
                            divisores: divisores,
                            valorPunto: saldoInicialGuardado
                        };
                        const jsonString = JSON.stringify(dataToExport, null, 2);
                        const blob = new Blob([jsonString], { type: 'application/json' });
                        currentExportUrl = URL.createObjectURL(blob);
                        
                        const exportLinkContainer = document.getElementById('exportLinkContainer');
                        exportLinkContainer.innerHTML = ''; 
                        
                        const a = document.createElement('a');
                        a.href = currentExportUrl;
                        a.download = `recaudacion_backup_${new Date().toISOString().slice(0, 10)}.json`;
                        a.textContent = 'Descargar Respaldo';
                        a.className = 'download-link';
                        
                        exportLinkContainer.appendChild(a);
                        showModal('exportModal');
                    } catch (error) {
                       showAlert('Error al generar el respaldo.');
                       console.error(error);
                    }
                }
                if (target.id === 'btnImportarJsonTrigger') {
                    allowAutoLogout = false;
                    document.getElementById('jsonFileInput').click();
                }
            });

            document.getElementById('jsonFileInput').onchange = (event) => {
                const file = event.target.files[0];
                if (!file) { return; }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        if (!content) throw new Error("El archivo de respaldo está vacío.");

                        const rawImportedData = JSON.parse(content);
                        if (!rawImportedData || typeof rawImportedData !== 'object') {
                            throw new Error("El archivo de respaldo no es un objeto JSON válido.");
                        }
                        
                        const dataToImport = {
                            recaudaciones: rawImportedData.recaudaciones || rawImportedData.datos || [],
                            valorPunto: rawImportedData.valorPunto || rawImportedData.saldoInicialGuardado || {},
                            notas: rawImportedData.notas || rawImportedData.notes || [],
                            divisores: rawImportedData.divisores || {}
                        };

                        if (!Array.isArray(dataToImport.recaudaciones)) {
                            throw new Error('El archivo de respaldo es inválido o no contiene datos de recaudación.');
                        }
                        
                        const confirmMessage = '¡ADVERTENCIA!\n\nEsto reemplazará TODOS los datos actuales con el contenido del archivo. Esta acción no se puede deshacer.\n\n¿Estás seguro de que quieres continuar?';
                        
                        showConfirm(confirmMessage, async () => {
                            showGlobalLoader('Importando datos...');
                            const response = await postToScript({
                                action: 'importAll',
                                data: dataToImport
                            });

                            if (response.status === 'success') {
                                await cargarDatosIniciales(true);
                                showAlert('Datos restaurados correctamente.');
                            } else {
                                const errorMessage = response.message || 'Error desconocido del servidor.';
                                showAlert(`No se pudieron importar los datos: ${errorMessage}`);
                            }
                            hideGlobalLoader();
                        });

                    } catch (error) {
                        showAlert(`Error al procesar el archivo: ${error.message}`);
                    } finally {
                        event.target.value = '';
                    }
                };
                reader.onerror = () => {
                    showAlert('Error: No se pudo leer el archivo seleccionado.');
                    event.target.value = '';
                };
                reader.readAsText(file);
            };

            document.addEventListener('input', e => {
                if (e.target.matches('.divisor-input')) {
                    const fecha = e.target.dataset.fecha;
                    const valor = e.target.value;
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(async () => {
                        divisores[fecha] = valor > 0 ? valor : undefined;
                        await postToScript({ action: 'updateDivisor', fecha, divisor: divisores[fecha] || null }); 
                        actualizarTotalGeneralDivision();
                        renderizarTabla(); 
                    }, 500);
                }
            });
            
            document.getElementById('agregarForm').onsubmit = e => {
                e.preventDefault();
                const performAdd = async () => {
                    const tipo = document.getElementById('tipo').value;
                    const fecha = document.getElementById('fecha').value;
                    // Se asume que el input de monto siempre tiene un punto como separador de miles si usa formatMonto
                    const monto = parseFloat(document.getElementById('monto').value.replace(/\./g, '')); 
                    if (!fecha || isNaN(monto)) { showAlert('Datos inválidos.'); return; }
                    showGlobalLoader('Agregando...');
                    const response = await postToScript({ action: 'add', fecha, tipo, monto });
                    if (response.status === 'success') {
                        document.getElementById('agregarForm').reset();
                        document.getElementById('fecha').value = new Date().toISOString().slice(0,10);
                        await cargarDatosIniciales(false);
                        document.querySelector('.menu-link[data-target="historialPanel"]').click();
                    }
                    hideGlobalLoader();
                };
                // Eliminado el showConfirm para 'guest'
                performAdd();
            };
            
            document.getElementById('editarForm').onsubmit = async e => {
                e.preventDefault();
                const tipo = document.getElementById('editarTipo').value;
                const fecha = document.getElementById('editarFecha').value;
                const monto = parseFloat(document.getElementById('editarMonto').value.replace(/\./g, ''));
                if (!fecha || isNaN(monto)) { showAlert('Datos inválidos.'); return; }
                showGlobalLoader('Guardando...');
                const response = await postToScript({ action: 'update', sheetIndex: editIndex, fecha, tipo, monto });
                if (response.status === 'success') {
                    hideModal('editModal');
                    await cargarDatosIniciales(false);
                }
                hideGlobalLoader();
            };
            
            document.getElementById('btnMinimizarTabla').onclick = () => { minimizado = !minimizado; document.getElementById('btnMinimizarTabla').textContent = minimizado ? 'Maximizar Tabla' : 'Minimizar Tabla'; renderizarTabla(); };
            document.getElementById('btnOrdenarFechaAsc').onclick = () => { ordenFecha = 'asc'; renderizarTabla(); };
            document.getElementById('btnOrdenarFechaDesc').onclick = () => { ordenFecha = 'desc'; renderizarTabla(); };
            document.getElementById('filtroFechas').oninput = () => renderizarTabla();
            document.getElementById('btnReiniciarFiltros').onclick = () => { document.getElementById('filtroFechas').value = ''; minimizado = true; document.getElementById('btnMinimizarTabla').textContent = 'Maximizar Tabla'; ordenFecha = 'desc'; renderizarTabla(); };
            document.getElementById('themeToggle').onclick = () => {
                const isDark = document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            };
            document.getElementById('scrollToTopBtn').onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
            window.onscroll = () => document.getElementById('scrollToTopBtn').classList.toggle('show', window.scrollY > 200);
            
            document.getElementById('notesFabBtn').onclick = () => {
                const targetId = 'notasPanel';
                const link = document.querySelector(`.menu-link[data-target="${targetId}"]`);
                if (!link) return;
                document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
                document.getElementById(targetId).classList.add('active');
                document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active-link'));
                link.classList.add('active-link');
                sessionStorage.setItem('activeTab', targetId);
                markNotesAsRead();
                if (window.innerWidth < 992) {
                    sideMenu.classList.remove('open');
                }
            };
            
            document.getElementById('btnProcesarImportacion').onclick = async () => {
                 const texto = document.getElementById('importDataTextarea').value;
                if (!texto) { showAlert('Pega el texto de los datos.'); return; }
                const lineas = texto.split('\n').map(l => l.trim()).filter(Boolean);
                const nuevasEntradas = [];
                let fechaActual = null;
                const regexFecha = /Día (\d{2}\/\d{2}\/\d{4})/;
                const regexMonto = /^- (Máquinas|Mesas|Otras|Otros):\s*\$?([\d.,]+)/;
                for (const linea of lineas) {
                    const matchFecha = linea.match(regexFecha);
                    if (matchFecha) {
                        const [day, month, year] = matchFecha[1].split('/');
                        fechaActual = `${year}-${month}-${day}`;
                        continue;
                    }
                    const matchMonto = linea.match(regexMonto);
                    if (matchMonto && fechaActual) {
                        let tipo = matchMonto[1];
                        if (tipo === 'Otros') tipo = 'Otras';
                        const monto = parseFloat(matchMonto[2].replace(/\./g, '').replace(',', '.'));
                        if (!isNaN(monto)) nuevasEntradas.push({ fecha: fechaActual, tipo, monto });
                    }
                }
                if (nuevasEntradas.length > 0) {
                    showGlobalLoader('Importando...');
                    for (const entrada of nuevasEntradas) { await postToScript({ action: 'add', ...entrada }); }
                    await cargarDatosIniciales(false);
                    hideGlobalLoader();
                    document.querySelector('.menu-link[data-target="historialPanel"]').click();
                } else { showAlert('No se encontraron datos válidos.'); }
            };
        };

        const initializeApp = async () => {
            loginOverlay.classList.add('hidden');
            mainContent.style.display = 'block';
            menuToggle.style.display = 'flex';
            document.body.classList.add('loggedin');
            // 'lastSeenKey' ahora usa el rol 'admin'
            lastSeenKey = `lastSeenNote_${currentUserRole}`; 
            document.body.classList.toggle('dark-mode', localStorage.getItem('theme') === 'dark');

            setupMenu();
            setupAppEventListeners();
            await cargarDatosIniciales();
            
            const savedTabId = sessionStorage.getItem('activeTab') || 'agregarPanel';
            const linkToActivate = document.querySelector(`.menu-link[data-target="${savedTabId}"]`);
            if (linkToActivate) {
                linkToActivate.click();
            }
            
            const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
            activityEvents.forEach(event => {
                window.addEventListener(event, resetInactivityTimer, true);
            });
            resetInactivityTimer();

            document.addEventListener('visibilitychange', () => {
              if (document.hidden && currentUserRole && allowAutoLogout) {
                logout();
              }
            });

            if (dataUpdateInterval) clearInterval(dataUpdateInterval);
            dataUpdateInterval = setInterval(() => {
                // Se podría optimizar esto, pero se mantiene la estructura original de refresco
                fetchFromScript({ action: 'get' }).then(res => { if(res.status === 'success') datos = res.data; renderizarTabla(); actualizarUI(); });
                fetchFromScript({ action: 'getNotes' }).then(res => { if(res.status === 'success') notes = res.data; renderizarNotas(); checkUnreadNotes(); });
            }, 15000);
        };

        const setupLoginListeners = () => {
            document.getElementById('loginForm').onsubmit = (e) => {
                e.preventDefault();
                const user = document.getElementById('username').value;
                const pass = document.getElementById('password').value;
                if (user === VALID_USERNAME && pass === VALID_PASSWORD) {
                    sessionStorage.setItem('userRole', 'admin');
                    currentUserRole = 'admin'; 
                    initializeApp();
                } else {
                    document.getElementById('loginMessage').textContent = 'Datos incorrectos.';
                    document.getElementById('loginMessage').style.display = 'block';
                }
            };
            // ELIMINADO: guestLoginBtn.onclick
            
            document.getElementById('togglePassword').onclick = function() {
                const passInput = document.getElementById('password');
                passInput.type = passInput.type === 'password' ? 'text' : 'password';
                this.classList.toggle('fa-eye-slash');
            };
        };

        const checkLogin = () => {
            // Solo verifica si el rol es 'admin'
            if (sessionStorage.getItem('userRole') === 'admin') {
                currentUserRole = 'admin';
                initializeApp();
            } else {
                loginOverlay.classList.remove('hidden');
                setupLoginListeners();
            }
        };
        
        checkLogin();
    });
    </script>
</body>
</html>